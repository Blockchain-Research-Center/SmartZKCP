pragma circom 2.0.3;


include "permutation.circom";
include "rolling.circom";

template CiminionEnc() {

    signal input MK_0;
    signal input MK_1;


    signal input PT[280];
    signal output CT[280];

    // sub key generation

    var keys[283] = [
            292334644102394411537362212093572878140,
            250282066453690133315708418387534650045,
            25210252274841859825108081164557115781,
            16246747660448753010909888379129524409,
            131669148524554050620166690622542333908,
            73395003443371763039182051680716568403,
            8260009929790711579150637832343448256,
            334561509980500295630109857265233755470,
            251572747396993099811617097119169178334,
            319551404291314842953250812519933899387,
            330640758715429519737303505376967190379,
            126057361753711913908703488930452556816,
            187899780603784731698151839689054581640,
            151057639745456246717215287663419796924,
            305609076732796609713444330396273784487,
            118448376296135774456375513776377201468,
            46454871715138680646845915938916802199,
            303637447071954698400920969187994679609,
            261293781192789842786771830734938690938,
            241691507804502561555688804203030780038,
            81929745328208047807564297881723656490,
            18198326379750965089917893649436623729,
            135868997836628286395541910575559147755,
            162651453722887278917702381886550269193,
            262871308786129854193859840200151476906,
            95849645594479220049429349396745744878,
            182852612228153313363054026504618598014,
            134544770119095787241864090128873870877,
            40541384435830279857438927956967931853,
            116513310841494518081479619488149410939,
            335658529325450061533605207278633204829,
            8856966265063174947869624775753304770,
            67172341740123816361927123146570128349,
            44482111308488328152107963475263739913,
            318818015539045234118066780480378419698,
            22109922917769998574560970444724415551,
            219533934777019508560371093053047011819,
            63796427300020888533622792187997329170,
            30085028647762965255196029328901776258,
            328552314159948043977345432484153790373,
            158217733191554104313546201402909503666,
            58146670617494901854016871848355784579,
            72838104975348767691430155472992232789,
            270256755022333391723662983264902114254,
            279432556993928842328288212179323509260,
            42498516548939541472411859202386669607,
            101770932702114991793479490435391053860,
            175728649992475958894655265138464837109,
            33204227079439574283247350727658105836,
            244539644225209453886555077234299660398,
            1310403725178485130097158507614814234,
            193482928194568493818837854786323536822,
            71100803467848427202770565852889735936,
            297461836292464924681748884118973606134,
            172488064579832119541060825118872930508,
            137953316723652647467286248883232015636,
            152921625387604874068191602776630654640,
            761592951778639687110021144905066369,
            213366124201344758141930971234857014456,
            21627440031347286729395951482213376700,
            208177731654530166777439946129867228536,
            169038580513031295989248684060597417385,
            176338801111316998533286255866276013259,
            75092999146096484406389206061691263845,
            316498167715264588075358124802239551448,
            26200644402925679136245596408177189364,
            107005702582340781795411656409052512254,
            335018274270043260757397087480193947914,
            207342776895569504287428531160138444860,
            217775666491901342561984748978147787653,
            263282949129650536422751461488307895499,
            274132011088045323247559411515746047383,
            163004054348401695600236132818346422129,
            11933906134099871770423587831424563302,
            40107199746705504466494304966262380133,
            62299304331812034354145039003976406204,
            107120668926610699674082314826705302885,
            51779832957253226887986971314240377501,
            322396792492322519803626030847860908826,
            72340263906292522461475793367197257369,
            339666889616377890736928553407270824818,
            203694605067543542789013510467394084240,
            178243066058824804355348013244028500953,
            276170685636890239816751196610149565085,
            112115533327877117584231397716542349912,
            12648796350618967052529879804094402777,
            247289788106160264183130727400795047680,
            260173788129571226449626673667505382561,
            272007032959866733955856002212359617061,
            103551808691584482345185284558074496912,
            61022184030201858367924415494974531657,
            86522777108509508640248673801195136899,
            318933320075244427182364547066763070828,
            192518069714674165749042872485792583952,
            251853380106995508734521595802246916151,
            168381027808569110409020722505337634752,
            305067398287075927724777219944369786516,
            15367067904427555413456125108005211521,
            276873999924598437824020556940362801181,
            244438417877330977927937890264620329755,
            54935201104827938399504075203514178762,
            47223971442719904056265880565346308479,
            209782723354525986921272800597047914470,
            247450816863108008189048770346317274351,
            337733814424202641533377526412935736616,
            85920496407649312068517979765621831525,
            56204751829804364845544700005382156571,
            64067286107019134177573413508179246296,
            258007449783479359375459728164957715432,
            95356764661552413808975112657018624755,
            230391013326551220182277178725693730318,
            84698366891316802108519222016877249695,
            204147455331520541353803669702582539469,
            24642718653743764165981549793263094779,
            171088509189533464703029998422944159671,
            139038518557697293222260087373603513375,
            163855392957681276521876929172495852095,
            305590203033340532037310128488250415381,
            48042047118357232992270495246145676807,
            238989902825270015733631855437625030372,
            298673493613513820847066015679469457568,
            129923625156059784224709783907476521896,
            183636336155875892662844469221780676532,
            110242309771143950947935849686286554633,
            253197658182190091591899725522778937810,
            334537541465067086903211658019651712516,
            49383261502578018738388985710375404457,
            317426005523709430290755321668123125904,
            16882487163418186840366982287889636161,
            116543259413426772862846691028145424460,
            207185903823180052364140821153943029884,
            95053977945778626635686103183487037286,
            86185975204138956938150994875944442098,
            256547669116373071155667953103051778960,
            283820875559046884924139116745529005321,
            221841563040388830307392962787612934720,
            195756801151231408977632978204894392761,
            262039879935348910357505169160934051657,
            289008251041638614082643428543713688546,
            16932612873918835683057402078863852873,
            260584801021419756724963385773524760671,
            298929346383242117885244648460692853783,
            241704250924386708454061190218109534371,
            8066283652795205980455221795968278884,
            324512671429935145074246395905158799939,
            317602998312795360541106607418076951113,
            3689344439563759647504531767468938060,
            6076611032550906462917483001954697516,
            245780342209654523127450980955577206303,
            24352318139832664643191110230900977426,
            206881262893949098092676029385132707110,
            283215996767785503404909519141208611699,
            101817288293173996081811083672397764256,
            157450784049772932764738923484639645765,
            195746673631245170476597958087627821204,
            292801601461989666690191540957408836106,
            68031819531906982118160541595243528723,
            172844546303229394108913233462927333076,
            326048358539278935582425489389783792277,
            29717082933420841425329973247956878953,
            226943769328679588312852450180142297945,
            189974526083445218172024592110970431250,
            213630451698088946285037981406032494838,
            276768164236971885533295176355394375814,
            316144355412675717750161676707283950694,
            134787738111510280739509237924390566932,
            24515866938579331774554106349228445282,
            33537778082620702181473715597568570646,
            41446417531684928546688012239020478904,
            339211330559550420085606537033480370314,
            249830222575693856918127783669147982806,
            277219659102302023087433224106616624500,
            150032916318887259361331811291434142875,
            275540576989457425769193421754811546157,
            136589615487283205633274773724607159507,
            196626736526280575262836170407866928203,
            200012841626498483556748380883080016911,
            170135743938055186650193229047405961257,
            334844079265362236695046513831721951542,
            76360701169055990429116658921252428635,
            28343824345935386617530576138201368060,
            290274631117636506210698495568680299790,
            233491875540241825942896359082151450654,
            211700599108774709344004869229973326846,
            234110468952713648336458973708792767643,
            88180754450721038123042573106918278037,
            333194208386432096046414610928638880456,
            122144099566817907767735772895898636169,
            158496047396732981535369856404604763980,
            181093611967773117034403783412053158217,
            126133781598363573833538908600250650601,
            61078456399013252822400023605092130679,
            4903443625959072123747893554539205312,
            254740395019996304314784515735829377233,
            230866583272771361713420115413968014577,
            106185057288423093514352748262299526687,
            46577739982368828307736823088955348489,
            243191554834862246552833934006274889274,
            281661909501698659809079780936344982226,
            8127424264469850645690935028192750077,
            94726293248278938626570996911218886633,
            100799996183648209124420970069981342892,
            116593603874024937494275603639585388234,
            79914180804391567303859538193830966572,
            221935616656084063920765838365222245435,
            220852731479779970890326363272344254442,
            255600470885456933965334720712630344547,
            285746131693379154467368350971063873245,
            34098114790817754801670313902297968215,
            255556410771031493238778867372536852427,
            52590055499301948145539956585014110541,
            59938678643308525135724777518717231443,
            82726710021216570408457897272004824280,
            133809287458790861664458811460910582698,
            31280558721060930715124403670851437835,
            33695259063424120510005663022917688065,
            216080175819844424366713776441228405838,
            268375159651215323650763977606911450092,
            161529187298449104287033519081991864474,
            23094297378471647354946723828376240834,
            250431839561743005841166869188038355924,
            314537984589900348626847435472940811043,
            39073148719041736225064981331693408664,
            324184320064740460655219755583177740260,
            226609149772868567297114667188237964955,
            305292390438030774614657304290291515918,
            281735807225944332479555927500158030459,
            254119352948954311370192065785211872901,
            75609600916155217001669061267635668536,
            158877932837294081720383411374221892653,
            40918910216707500398080721274835116765,
            193562402909689772926038525773079227256,
            120258703346826078624528037873778733798,
            206193354716038540600488668842300787180,
            100044594416753207523730046633944070915,
            335943190210028963870152197535575258095,
            295457956356848256412005033693768709556,
            228290858216825434725798452821240234542,
            55794743370848056686570289092527722218,
            110807699005908127813014792657283558088,
            123322314477054801520051759324877281609,
            122083252480496384468683948828086489504,
            310376703578379987729859976423414774807,
            338927036492959277022185824072574507073,
            274197076337926626659400988478509749367,
            62422695666212095176872053679137921572,
            173612401908995456223795409011293464784,
            67293157255625531921078779012182599784,
            236358661447165400862364047371294425863,
            269049547565033944217060479228815609144,
            183443717298621063585797992396716527415,
            181711387981188281924433992457956685517,
            249012176813323028935387833957682403137,
            275999521309020295684332272946500556247,
            158168659184359520785318837652810048872,
            222665311845030198125999703929306195929,
            266671205975740229198483568655991240795,
            257342917507086185698765134864397858304,
            139067141548106635799166437244022347129,
            193427651514726542938959678268172841326,
            75100253162519920264480517591950871223,
            103002416003978467450835192142331406548,
            226293223026576945057430663341478874258,
            266855213210882800584587788973337866119,
            321001196947231315161367002550204374580,
            23106589684736339409819494149781068894,
            60415478157058649878343770194292198333,
            6050096053096298870715677153569338511,
            264534224343140973858217287843938116768,
            169588104853215091749354381894197762335,
            91467644214736738606381629486558917553,
            189434568431437082014862617305642219848,
            103595602782137515621682810501337117696,
            294126971671607352356739626767375441699,
            285866527466854890447830140086180760335,
            312994140684428683056107926211958475146,
            293703229734963762998703471863245132493,
            29860725971403449123593529370870064884,
            174168857312731948328895490444365816718,
            268077209920313955939902336890215968764,
            239789353213687594274208753636440281835,
            162081859657067003656120164846190352629,
            47647205462797583633440545071885285040];

    // first permutation pN
    
    component p_n = IteratedPermutationN();
    p_n.a0 <== 0;
    p_n.b0 <== keys[1];
    p_n.c0 <== keys[2];

    component rolls[140];
    component p_rs[140];

    // start main loop

    for (var i = 0; i < 140; i++) {
        // roll

        rolls[i] = Rolling();

        if (i == 0) {
            rolls[i].s0 <== p_n.a1 + keys[2*i + 4];
            rolls[i].s1 <== p_n.b1 + keys[2*i + 3];
            rolls[i].s2 <== p_n.c1;
        } else {   
            rolls[i].s0 <== rolls[i-1].b0 + keys[2*i + 4];
            rolls[i].s1 <== rolls[i-1].b1 + keys[2*i + 3];
            rolls[i].s2 <== rolls[i-1].b2;
        }
 
        // second permutation pR

        p_rs[i] = IteratedPermutationR();

        p_rs[i].a0 <== rolls[i].b0;
        p_rs[i].b0 <== rolls[i].b1;
        p_rs[i].c0 <== rolls[i].b2;

        CT[2*i] <== p_rs[i].a1 + PT[2*i];
        CT[2*i + 1] <== p_rs[i].b1 + PT[2*i + 1];

    }
}

component main = CiminionEnc();